<!doctype html>
<html>
  <head>

    <style>
    
    body, html{
  height: 100%;
}
    
    .loading {
  width: 50px;
  height: 50px;
}

 

.geral{

width:100%;
height:100vh;
z-index:300;
position:absolute;
display:flex;
flex-direction:row;
align-items:center;
justify-content:center;
background-color:rgba(10,23,55,0.5);
}


.container-inscricao{

width:100%;
height:100%;
z-index:300;
position:absolute;
display:flex;
flex-direction:row;
align-items:center;
justify-content:center;
background-color:rgba(10,23,55,0.5);
}

.container-inscritos{

width:100%;
height:100%;
z-index:300;
position:absolute;
display:flex;
flex-direction:row;
align-items:center;
justify-content:center;
background-color:rgba(10,23,55,0.5);
}




</style>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css"/>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<title>Estoque APH 9ºBBM</title>
    

 
    
  </head>
  
<body>
<!-- div class="alert alert-primary" role="alert" style="width: 80%; margin-top:10px; padding:5px;background:#FFF;border: 1px solid #DCDCDC; border-radius:5px;">
  A simple primary alert—check it out!
</div-->
   <div class="geral">
   <img class="loading" src="https://i.gifer.com/ZKZx.gif"/>
  </div>  

  <div class="container-inscricao">

  <div class="card" id="sas"style="width: 80%; margin-top:10px; padding:5px;background:#FFF;border: 1px solid #DCDCDC; border-radius:5px;">
  <div class="card-body" style="width: 100%; padding:5px">

    <div style="display:flex;width:100%;justify-content:space-between; align-items: center">   <h5 class="card-title" style="font-size:1.2em; font-weight:600;color:#333"> <span class="nome-curso"></span></h5> <span class="fechar-inscricao" style="padding:5px;font-size:1.2em;cursor:pointer">X</span> </div>


    <div class="alteracoes" style="margin:auto;overflow-y:scroll; display:block; width:100%; padding:5px;height:300px;">


    </div>
    
    
    <div style="display:flex;flex-direction:column;justify-content:center;align-items:center; width:100%; padding:5px;">

      <div class="item-novo" style="display:flex;flex-direction:column;justify-content:center;align-items:center; width:100%; margin-bottom:5px">

 <input type="text" class="form-control nome-item" placeholder="Nome do item" style="margin-top:5px;font-size:1.2em;height:40px"/>
 <input type="number" class="form-control qtd-item" placeholder="Quantidade" min="0" style="margin-top:5px;font-size:1.2em;height:40px"/>

      </div>
   
        <input type="time" class="form-control hora" placeholder="Horário" style="font-size:1.2em;height:40px"/>
          <input type="date" id="dateInput" class="form-control data" placeholder="Data" style="margin-top:5px;font-size:1.2em;height:40px"/>

    <input type="text" class="form-control" id='num-mtcl'  placeholder="Matrícula (BM) ou CPF (BC)" style="margin-top:5px;font-size:1.2em;height:40px"/>
    <button class="form-control prosseguir" style="background:#DCDCDC;margin-top:10px">Prosseguir</button>
    </div>


    <div style="display:flex;justify-content:center;align-items:center"><img class="loading load-pro" style="width:20px;height:20px" src="https://i.gifer.com/ZKZx.gif"/></div>


    <div id="dados-ins" style="display:flex;justify-content:space-between;align-items:center;padding:10px">
      <div style="display:flex;flex-direction:column;align-items:center"><span id="nome-inscricao"></span>

       <textarea id="obs" class="form-control motivo" style="margin-top:10px;" placeholder="Digite alguma observação, caso deseje"></textarea>
      

</div>
      <div class="botao-ins" style="color:#FFF;cursor:pointer;border: 1px solid #DCDCDC; border-radius:5px;width: 80px; padding:5px;background:#93bf85; text-align:center">Salvar Alterações</div>
       
    <div style="display:flex;justify-content:center;align-items:center" class="load-ins"><img class="loading" style="width:20px;height:20px" src="https://i.gifer.com/ZKZx.gif"/></div>
       
      </div>

    
    
    
  </div>
</div>
<span class="link" style="display:none"><?!= param ?></span>
</div>



<div class="container-main" style="display:block">
  <div style="background:#C8102E;display:flex;flex-direction:row;justify-content:flex-start;align-items:center; padding:5px">
  <div style="background:#C8102E;">  <!--img src="https://drive.google.com/uc?export=view&id=1zvaFRrQWdvk-mLggpsyFMK2QhOBedtHB"/--> </div>
  <!--src="https://drive.google.com/thumbnail?id=1zvaFRrQWdvk-mLggpsyFMK2QhOBedtHB&sz=w1000"-->

  <h1 style="font-size:2em;margin-left:10px;color:#FFF">Atendimento Pré-Hospitalar (APH)</h1>

  </div>
<div class="container-acao" style="width:100%;display:flex;align-items: center;flex-direction:column">

  <div class="container-acao" style="width:80%;display:flex;align-items: center;flex-direction:column; margin-top:20px">
  <input type="button" class="form-control" name="retirada" value="Retirada de Itens do Estoque" style="padding:10px; margin: 10px; background:#dc0044;color:#FFF; border-radius:5px; border:1px solid #FFF; height:120px; font-size:2em"/>
<input type="button" class="form-control" name="reposicao" value="Reposição do Estoque" style="padding:10px; margin: 10px; background:#005eff;color:#FFF; border-radius:5px; border:1px solid #FFF; height:120px; font-size:2em"/> 
 <input type="button" class="form-control"  name="recontagem" value="Recontagem Geral do Estoque" style="padding:10px; margin: 10px; background:#8aad34;color:#FFF; border-radius:5px; border:1px solid #FFF; height:120px; font-size:2em"/>
  </div>

    </div>



<div class="container-tudo">


 
<div style="display:flex;flex-direction:row;justify-content:center;align-items:center;width:100%;margin-top:10px"> <span class="opcao-atual" style="color:#333;font-size:1.8em;"></span></div>

<div class="container-opcoes"  style="display:flex;flex-direction:row;justify-content:center;align-items:center;width:100%;margin-top:20px">


  <input type="button" value="Item não relacionado" name="nitem" class="form-data" style="padding:10px;background:#ffde21;color:#000; border-radius:5px; border:1px solid #FFF;margin:10px; height:60px; font-size:1.2em"/>
  <input type="button" value="Salvar Alterações" name="salvar" class="form-data" style="padding:10px;background:#005eff;color:#FFF; border-radius:5px; border:1px solid #FFF;margin:10px; height:60px; font-size:1.2em"/>
  <input type="button" value="Cancelar" name="cancelar" class="form-data" style="padding:10px;background:#dc0044;color:#FFF; border-radius:5px; border:1px solid #FFF; margin:10px; height:60px; font-size:1.2em"/>


</div>

<div class="container-pesquisa" style="display:flex;flex-direction:row;justify-content:center;align-items:center;width:100%">
  <input type="text" class="form-control pesquisa" placeholder="Pesquise um item..." style="padding:5px;margin:10px; width:80%; height:60px; font-size:1.5em"/>
  <input type="button" value="Buscar" class="form-data btbus" style="padding:10px;background:#005eff;color:#FFF; border-radius:5px; border:1px solid #FFF; height:60px; font-size:1.2em"/>
    <div style="display:flex;justify-content:center;align-items:center" class="load-bus"><img class="loading" style="width:20px;height:20px" src="https://i.gifer.com/ZKZx.gif"/></div>
</div>

<div class="container-itens" style="width:100%;display:flex;align-items: center;flex-direction:column"></div>


</div>

  </div>  

  <script>
$(function() {

  let opcao = 0;
let array_itens=[];
let array_controle=[];
let url =   'https://script.google.com/macros/s/AKfycbzE0E65BfA1fqyh3e2KDPAaU6HDdLwlzl_GYv5AOXBV/dev';


let ind_qual=0;
  let nome_inscricao=null;



  var today = new Date();
  var maxDate = today.toISOString().split('T')[0]; // Formata a data como AAAA-MM-DD
  document.getElementById("dateInput").setAttribute("max", maxDate);



function inicio(){
opcao = 0;
 array_itens=[];
 array_controle=[];
 url =   'https://script.google.com/macros/s/AKfycbzE0E65BfA1fqyh3e2KDPAaU6HDdLwlzl_GYv5AOXBV/dev';


 ind_qual=0;
   nome_inscricao=null;



   today = new Date();
   maxDate = today.toISOString().split('T')[0]; // Formata a data como AAAA-MM-DD
  document.getElementById("dateInput").setAttribute("max", maxDate);


/* Código Refresh
$('.container-acao').on('click','#linkteste',(g)=>{

google.script.run
      .withSuccessHandler(function(url){
        window.open(url,'_top');
      })
      .getScriptURL();

});
*/




    $('.container-tudo').hide();
    $('.container-itens').hide();
     $('.container-inscricao').hide();
               $('.load-pro').hide();  
           $('#dados-ins').hide();
             $('.load-ins').hide();
             $('.item-novo').hide();
                $('.load-bus').hide();


    try{
google.script.run.withSuccessHandler(data=>{
  //alert(data);
  //$('.geral').hide();

  if(JSON.parse(data)!=null){

 // console.log(data);
 array_itens = [...JSON.parse(data)];

 array_controle=  [...JSON.parse(data)];

//console.log(editais);

  JSON.parse(data).map((o,j)=>{
 
 geraItem(o);
  

if(j==JSON.parse(data).length-1){

 
  $('.geral').hide();
  
  
  }


  });}

 
  
  
  
  }).getAllItens();
}catch(e){console.log(e.message)}




}


inicio();




  if($('.link').html()!=''&&$('.link').html()!='undefined'){

// Invalidar

  try{
google.script.run.withSuccessHandler(data=>{
  //alert(data);
  //$('.geral').hide();
console.log(data);


  if(JSON.parse(data)!=null){

if(JSON.parse(data)[0]==200){
alert("Solicitação de cancelamento de registro enviada com sucesso!");


}else if(JSON.parse(data)[0]==400){

alert("Solicitação de cancelamento de registro intempestiva!");

}else{

  alert("Falha na solicitação!");
}




  }

 
  
  
  
  }).invalidar($('.link').html());
}catch(e){console.log(e.message)}

  }





 function geraItem(objeto,opcao=0){


$('.container-itens').append(`<div class="card" id="ed-${objeto[0]}"style="width: 80%; margin-top:10px; padding:5px;">
  <div class="card-body card-item${objeto[0]}" style="border: 1px solid #DCDCDC; border-radius:5px;width: 100%; padding:5px; font-size:2em">
  <div style="display:flex;align-items:center;justify-content:space-between;">
    <h5 class="card-title" style="font-size:1.2em">${objeto[1]}</h5>


<!-- icone pessoas -->

 <div posicao="${objeto[0]}" style="padding:10px; display:flex; flex-direction:row;justify-contente:center;align-items:center">  
 
 <input type="button" class="mais" posicao="${objeto[0]}"  value="+"/> 
 <input type="number" min="0" name="quantidade${objeto[0]}" style="width:50px; margin-left:5px; margin-right:5px;text-align:center" value="${opcao==0?objeto[4]==""?0:parseInt(objeto[4]):objeto[3]==""?0:parseInt(objeto[3])}"/>
  <input type="button" class="menos" posicao="${objeto[0]}"  value="-"/> 
        </div>



    </div>
  
  </div>
</div>`);


 }


 $('.container-acao').on('click',"input[name='retirada']",(n,m)=>{
 
opcao=1;
$('input[name="nitem"]').fadeIn();
$('.opcao-atual').html("Retirada de Itens do Estoque");
    $('.container-tudo').fadeIn();
    $('.container-itens').fadeIn();
      $('.container-acao').hide();


 });

  $('.container-acao').on('click',"input[name='reposicao']",(n,m)=>{
 
opcao=2;
$('input[name="nitem"]').fadeIn();

$('.opcao-atual').html("Reposição do Estoque");
    $('.container-tudo').fadeIn();
    $('.container-itens').fadeIn();
      $('.container-acao').hide();


 });


  $('.container-acao').on('click',"input[name='recontagem']",(n,m)=>{
 
opcao=3;

$('input[name="nitem"]').hide();

$('.opcao-atual').html("Recontagem Geral do Estoque");
    $('.container-tudo').fadeIn();
    $('.container-itens').fadeIn();
      $('.container-acao').hide();
$('.container-itens').html("");

array_itens.map((o,j)=>{

  if(j==0){

    console.log(o);
  }
 
 geraItem(o,1);

  });






 });


$('.container-opcoes').on('click',"input[name='cancelar']",(n,m)=>{
 
opcao=0;

array_itens =  JSON.parse(JSON.stringify(array_controle));
$('.opcao-atual').html("");
    $('.container-tudo').hide();
    $('.container-itens').hide();
      $('.container-acao').fadeIn();

      $('.container-itens').html("");
     

array_itens.map((o,j)=>{
 
 geraItem(o);

  });

});




$('.container-itens').on('click',".mais",(n,m)=>{

  let local= opcao==3?3:4;

let obj =array_itens[parseInt(n.target.getAttribute("posicao"))-1];

array_itens[parseInt(n.target.getAttribute("posicao"))-1][local] = parseInt(obj[local])+1;



$(`input[name='quantidade${n.target.getAttribute("posicao")}'`).val(parseInt($(`input[name='quantidade${n.target.getAttribute("posicao")}'`).val())+1);

if(parseInt(array_itens[parseInt(n.target.getAttribute("posicao"))-1][local])!=parseInt(array_controle[parseInt(n.target.getAttribute("posicao"))-1][local])){
$(`.card-item${n.target.getAttribute("posicao")}`).css('background','#a2d8f7');
}else{
  $(`.card-item${n.target.getAttribute("posicao")}`).css('background','#FFF');
}

});


$('.container-itens').on('click',".menos",(n,m)=>{


  let local= opcao==3?3:4;

let obj =array_itens[parseInt(n.target.getAttribute("posicao"))-1];

array_itens[parseInt(n.target.getAttribute("posicao"))-1][local] = parseInt(obj[local])-1>=0?parseInt(obj[local])-1:0;



$(`input[name='quantidade${n.target.getAttribute("posicao")}'`).val(parseInt($(`input[name='quantidade${n.target.getAttribute("posicao")}'`).val())-1>=0?parseInt($(`input[name='quantidade${n.target.getAttribute("posicao")}'`).val())-1:0);

if(parseInt(array_itens[parseInt(n.target.getAttribute("posicao"))-1][local])!=parseInt(array_controle[parseInt(n.target.getAttribute("posicao"))-1][4])){
$(`.card-item${n.target.getAttribute("posicao")}`).css('background','#a2d8f7');
}else{
  $(`.card-item${n.target.getAttribute("posicao")}`).css('background','#FFF');
}

});





//Pesquisa Item


$('.container-pesquisa').on('keyup','.pesquisa',(e)=>{



  $('.container-itens').html('');


let percorre = array_itens;

/*if(opcao==3){
let percorre = array_controle;
}*/

if(document.getElementsByClassName('pesquisa')[0].value!=""){

percorre= percorre.filter((o,u)=>{return o[1].toLowerCase().includes(document.getElementsByClassName('pesquisa')[0].value.toLowerCase())||o[2].toLowerCase().includes(document.getElementsByClassName('pesquisa')[0].value.toLowerCase())?1:0});

}

  percorre.map((o,j)=>{

  if(j==0){

    console.log(o);
  }
 
 geraItem(o,opcao==3?1:0);

  });
 
  });


//Pesquisa Item Gemini

$('.container-pesquisa').on('click','.btbus',(e)=>{



  $('.container-itens').html('');
  $('.btbus').hide();
  $('.load-bus').fadeIn();

let percorre = array_itens;


if(document.getElementsByClassName('pesquisa')[0].value!=""){

google.script.run.withSuccessHandler(data=>{
  //alert(data);
  //$('.geral').hide();

  if(JSON.parse(data)!=null){
console.log('aqui n');
    if(JSON.parse(data)[0]==400){
console.log('aqui 400');
//Não há correspondência

  $('.btbus').fadeIn();
  $('.load-bus').hide();

    }else{
console.log('aqui 200');
console.log(JSON.parse(data)[1]);
JSON.parse(data)[1].map((n,m)=>{

percorre.map((o,u)=>{

if(o[1].toLowerCase().includes(n[1].toLowerCase())){

geraItem(o,opcao==3?1:0);

}

});


});



  $('.btbus').fadeIn();
  $('.load-bus').hide();


    }

  }else{

      $('.btbus').fadeIn();
  $('.load-bus').hide();
  }

  
  
  }).gemini(document.getElementsByClassName('pesquisa')[0].value);


}else{
  $('.btbus').fadeIn();
  $('.load-bus').hide();

}



 
  });






  //Abrir página de inscrição de registro

  //Inscrever-se
  

$('.container-opcoes').on('click','input[name="salvar"]',(e)=>{

  ind_qual=0;
  fazerHoraDataAtual();
  $('.container-inscricao').css('height','100%').fadeIn(); 
  $('.container-tudo').hide();
  $('.nome-curso').html(opcao==1?'Retirada de Itens do Estoque':opcao==2?'Reposição de Estoque':'Recontagem Geral do Estoque');

let local = opcao==3?3:4;

$('.alteracoes').fadeIn();
$('.item-novo').hide();

$('.alteracoes').html('');
array_itens.filter((k,h)=>{

return parseInt(array_controle[h][local])!=parseInt(k[local])?1:0



}).map((d,f)=>{


    $('.alteracoes').append(`<div style="margin:auto;font-size:1.2em"> ${d[1]} <span style="padding:5px;background:#DCDCDC">(${d[local]})</span></div>`);
});

 


 

  });



    //Item novo, cadastro

$('.container-opcoes').on('click','input[name="nitem"]',(e)=>{

  ind_qual=1;
  fazerHoraDataAtual();
  $('.container-inscricao').css('height','100%').fadeIn(); 
  $('.container-tudo').hide();
  $('.nome-curso').html(opcao==1?'Retirada de Itens do Estoque':opcao==2?'Reposição de Estoque':'Recontagem Geral do Estoque');

let local = opcao==3?3:4;

$('.alteracoes').hide();
$('.item-novo').fadeIn();
 

  });



//Fechar Container inscrever registro


$('.container-inscricao').on('click','.fechar-inscricao',(e)=>{
  
  $('.container-inscricao').hide(); 
    $('.container-tudo').fadeIn();
  
  

  });









//Procura militar ou bc no BD

$('.container-inscricao').on('click','.prosseguir',(e)=>{
     $('.load-pro').fadeIn();
//Inscrição
//alert($('.num-mtcl').html());

google.script.run.withSuccessHandler(data=>{
  //alert(data);
  //$('.geral').hide();

  if(JSON.parse(data)!=null){

  console.log(data);

//Há inscrito
   $('.load-pro').hide();
     $('#dados-ins').fadeIn();
     obj_ins = JSON.parse(data)[0];
$('#nome-inscricao').html(`${JSON.parse(data)[0][1]} ${JSON.parse(data)[0][4]=="Sim"||JSON.parse(data)[0][4]=="Não"?JSON.parse(data)[0][2]:JSON.parse(data)[0][4]}`);

nome_inscricao= JSON.parse(data)[0];

  JSON.parse(data).map((o,j)=>{
 
  //console.log(o);



  });}else{

    //Não há inscrito
     $('.load-pro').hide();
    alert("não há bombeiro correspondente a essa pesquisa!");
  }

 
  
  
  
  }).getNomeInscrito(document.getElementById('num-mtcl').value);


});


//Salvar Registro:

$('.container-inscricao').on('click','.botao-ins',(n,b)=>{

// Acessar BD, salvar registro

$('.botao-ins').hide();
$('.load-ins').fadeIn();


let local = opcao==3?3:4;

let vai = array_itens.filter((k,h)=>{

return parseInt(array_controle[h][local])!=parseInt(k[local])?1:0



});

let term_p = true;


if(ind_qual==1){

  if($('.nome-item').val()==""||$('.qtd-item').val()==""){
    term_p=false;
  }

vai = [$('.nome-item').val(),
$('.qtd-item').val()];

}else{

if(vai.length==0){
  term_p=false;
}

}




if(!$('.hora').val()||!$('.data').val()||!term_p){
  alert("Faltam informações para realizar a ação!");
  $('.botao-ins').fadeIn();
$('.load-ins').hide();



}else{

 



let horaData = `${$('.hora').val()} ${$('.data').val()}`;

let motivo = $('.motivo').val();






  try{
google.script.run.withSuccessHandler(data=>{

console.log(JSON.parse(data));

  if(JSON.parse(data)!=null){

console.log(JSON.parse(data));
  
 
 

  if(JSON.parse(data)[0]==200){

alert("Registro Cadastrado com sucesso!");


$('.botao-ins').fadeIn();
$('.load-ins').hide();

  
//Refresh


$('.container-acao').fadeIn();
$('.geral').fadeIn();
inicio();






}else{


   alert("não foi possível registrar a alteração no estoque!");
   $('.botao-ins').fadeIn();
$('.load-ins').hide();

}


 
  
  
  
  }else{

    //Não houve retorno
     
    alert("não foi possível registrar a alteração no estoque!");
    $('.botao-ins').fadeIn();
$('.load-ins').hide();
  }

 
  
  
  
  }).setRegistro(ind_qual,vai,nome_inscricao,motivo,opcao,horaData);

}catch(e){
  console.log(e);
}


}

});

function fazerHoraDataAtual(){

 const hoje = new Date().toISOString().split("T")[0];
    document.getElementsByClassName("data")[0].value = hoje;

    // Hora atual (HH:MM)
    const agora = new Date();
    const hora = agora.getHours().toString().padStart(2, "0");
    const minutos = agora.getMinutes().toString().padStart(2, "0");
    document.getElementsByClassName("hora")[0].value = `${hora}:${minutos}`;
  }



 }); 


</script>

</body>
</html>

